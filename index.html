<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gram Vidhya</title>
  <style>
    /*
      Math Blaster - Single file prototype
      Minimal, responsive, no dependencies
    */

    :root {
      --bg: #0f1226;
      --panel: #171a36;
      --panel-2: #1f2347;
      --text: #f3f6ff;
      --muted: #b9c0ff;
      --accent: #7aa2ff;
      --accent-2: #00d1b2;
      --danger: #ff5c7a;
      --gold: #ffd166;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, #1a1f4a, transparent),
                  radial-gradient(900px 500px at 110% 10%, #1a1f4a, transparent),
                  var(--bg);
      min-height: 100svh;
      display: flex;
      flex-direction: column;
    }

    .container {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    header {
      padding: 12px 16px;
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border-bottom: 1px solid #2a2f68;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: 0.5px;
    }

    .content {
      flex: 1;
      display: flex;
      align-items: stretch;
    }

    /* Panels */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));
      border: 1px solid #2a2f68;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.04);
    }

    /* Left main area */
    .left {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .landing {
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: end;
    }

    .landing h2 {
      grid-column: 1 / -1;
      margin: 0 0 4px 0;
      font-size: 18px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .field {
      display: grid;
      gap: 6px;
    }
    .field label {
      font-size: 12px;
      color: var(--muted);
    }
    select, input[type="text"] {
      background: #121433;
      border: 1px solid #2b3080;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
      transition: border-color .2s, transform .05s;
    }
    select:focus, input[type="text"]:focus {
      border-color: var(--accent);
    }
    .actions {
      display: flex;
      align-items: end;
      gap: 8px;
    }
    .btn {
      background: linear-gradient(180deg, #3b5bff, #2943d7);
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      letter-spacing: .4px;
      cursor: pointer;
      transition: transform .05s ease, opacity .2s;
      user-select: none;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.secondary {
      background: linear-gradient(180deg, #2b2f66, #1f234f);
    }

    /* HUD */
    .hud {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 12px;
      align-items: center;
    }
    .hud .tile {
      background: #121433;
      border: 1px solid #2a2f68;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }
    .hud .label { color: var(--muted); font-size: 12px; }
    .hud .value { font-size: 18px; font-weight: 800; }

    .lives span { font-size: 20px; margin: 0 2px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4)); }

    /* Gameplay */
    .game {
      padding: 16px;
      display: grid;
      place-items: center;
      min-height: 320px;
    }
    .card {
      width: min(520px, 100%);
      background: radial-gradient(500px 160px at 50% -20%, rgba(122,162,255,0.15), transparent), #111433;
      border: 1px solid #2b3080;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: pop .18s ease;
    }
    @keyframes pop { from { transform: scale(.98); opacity: 0 } to { transform: scale(1); opacity: 1 } }
    .problem {
      font-size: 28px;
      font-weight: 800;
      text-align: center;
      letter-spacing: .6px;
      margin: 10px 0 16px;
    }
    .choices { display: grid; gap: 10px; grid-template-columns: 1fr; }
    .choice {
      padding: 12px;
      background: #181b44;
      border: 1px solid #2a2f68;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      font-weight: 700;
      transition: transform .05s ease, background .2s, border-color .2s;
      user-select: none;
    }
    .choice:hover { background: #1b1f51; }
    .choice.correct { border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(0,209,178,.25) inset; }
    .choice.wrong { border-color: var(--danger); animation: wobble .25s ease; }
    @keyframes wobble { 25%{ transform: translateX(-3px) } 75%{ transform: translateX(3px) } }

    .xp {
      position: absolute;
      pointer-events: none;
      color: var(--gold);
      text-shadow: 0 2px 6px rgba(0,0,0,.6);
      animation: rise 650ms ease forwards;
      font-weight: 800;
    }
    @keyframes rise { from { transform: translateY(6px); opacity: 0 } 40%{ opacity: 1 } to { transform: translateY(-18px); opacity: 0 } }

    /* Leaderboard */
    .right.leaderboard {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .right h3 { margin: 0; font-size: 16px; color: var(--muted); }
    .lb-list { display: grid; gap: 8px; }
    .lb-item {
      background: #121433;
      border: 1px solid #2a2f68;
      border-radius: 10px;
      padding: 8px 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }
    .lb-meta { color: var(--muted); font-size: 12px; }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(5, 7, 20, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      width: min(520px, 92%);
      background: #111433;
      border: 1px solid #2a2f68;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      animation: pop .18s ease;
    }
    .modal h3 { margin: 4px 0 12px; }

    /* Responsive */
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="panel">
    <div class="brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M12 2l2.39 4.84 5.34.78-3.86 3.76.91 5.32L12 14.77 7.22 16.7l.91-5.32L4.27 7.62l5.34-.78L12 2z" fill="#7aa2ff"/>
      </svg>
      <h1>Gram Vidhya</h1>
    </div>
  </header>

  <div class="container content">
    <section class="left">
      <!-- Landing / Controls -->
      <div class="panel landing">
        <h2>Ready, Set, Blast!</h2>
        <div class="field">
          <label for="playerName">Player Name</label>
          <input id="playerName" type="text" placeholder="Enter your name" autocomplete="off" />
        </div>
        <div class="field">
          <label for="subject">Subject</label>
          <select id="subject">
            <option value="Math">Math</option>
            <option value="SocialStudies">Social Studies</option>
          </select>
        </div>
        <div class="field">
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="Competitive">Competitive</option>
            <option value="Learning">Learning</option>
          </select>
        </div>
        <div class="field">
          <label for="grade">Grade</label>
          <select id="grade">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
          </select>
        </div>
        <div class="field">
          <label for="difficulty">Difficulty</label>
          <select id="difficulty">
            <option value="Easy">Easy</option>
            <option value="Medium">Medium</option>
            <option value="Hard">Hard</option>
          </select>
        </div>
        <div class="actions">
          <button id="startBtn" class="btn" disabled>Start</button>
          <button id="resetBtn" class="btn secondary">Reset</button>
        </div>
      </div>

      <!-- HUD -->
      <div class="panel hud">
        <div class="tile">
          <div class="label">Time</div>
          <div class="value" id="time">60</div>
        </div>
        <div class="tile">
          <div class="label">Score</div>
          <div class="value" id="score">0</div>
        </div>
        <div class="tile">
          <div class="label">Multiplier</div>
          <div class="value" id="multiplier">x1</div>
        </div>
        <div class="tile">
          <div class="label">Lives</div>
          <div class="value lives" id="lives">❤️❤️❤️</div>
        </div>
      </div>

      <!-- Gameplay Area -->
      <div class="panel game">
        <div class="card" id="card" style="display:none">
          <div class="problem" id="problem">7 + 5 = ?</div>
          <div class="choices">
            <div class="choice" data-idx="0" id="choice0">A) 10</div>
            <div class="choice" data-idx="1" id="choice1">B) 12</div>
            <div class="choice" data-idx="2" id="choice2">C) 14</div>
          </div>
          <div id="explain" style="display:none; margin-top:12px;">
            <div class="panel" style="padding:12px; border-radius:10px; background:#0f1336; border:1px solid #2a2f68;">
              <div style="font-weight:800; margin-bottom:8px; color: var(--gold);">Why these answers?</div>
              <div id="explainList" style="display:grid; gap:6px; font-size:14px;"></div>
              <div id="tip" class="lb-meta" style="margin-top:8px; font-size:13px;"></div>
              <div style="display:flex; gap:8px; margin-top:10px;">
                <button id="nextBtn" class="btn">Next</button>
              </div>
            </div>
          </div>
        </div>
        <div id="idleHint" style="text-align:center;color:var(--muted);">
          Press Start to begin. Solve as many as you can!
        </div>
      </div>
    </section>

    <!-- Leaderboard -->
    <aside class="panel right leaderboard">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <h3>Leaderboard (Top 5)</h3>
        <button id="clearLb" class="btn secondary" style="padding:6px 10px; font-weight:600;">Clear</button>
      </div>
      <div id="lbList" class="lb-list"></div>
      <div class="lb-meta">Scores saved locally on this device.</div>
    </aside>
  </div>

  <!-- End Game Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="endTitle">
    <div class="modal">
      <h3 id="endTitle">Game Over</h3>
      <p>Your Score: <strong id="finalScore">0</strong></p>
      <div class="field" style="margin:10px 0;">
        <label for="submitName">Submit Score As</label>
        <input id="submitName" type="text" placeholder="Your name" />
      </div>
      <div style="display:flex; gap:8px;">
        <button id="submitScore" class="btn">Submit to Leaderboard</button>
        <button id="closeModal" class="btn secondary">Close</button>
      </div>
    </div>
  </div>

  <script>
    // =============================
    // CONFIG
    // =============================
    const CONFIG = {
      basePoints: 10,
      startTimeSeconds: 60,
      maxLives: 3,
      leaderboardKey: 'mathBlasterLeaderboardV1'
    };

    // =============================
    // STATE
    // =============================
    const state = {
      playerName: '',
      grade: 1,
      difficulty: 'Easy',
      subject: 'Math',
      mode: 'Competitive',
      score: 0,
      streak: 0,
      multiplier: 1,
      lives: CONFIG.maxLives,
      timeLeft: CONFIG.startTimeSeconds,
      timerId: null,
      currentProblem: null,
      currentChoices: [],
      currentExplainData: [],
      correctIndex: 0,
      gameActive: false
    };

    // Elements
    const el = {
      playerName: document.getElementById('playerName'),
      subject: document.getElementById('subject'),
      mode: document.getElementById('mode'),
      grade: document.getElementById('grade'),
      difficulty: document.getElementById('difficulty'),
      startBtn: document.getElementById('startBtn'),
      resetBtn: document.getElementById('resetBtn'),
      time: document.getElementById('time'),
      score: document.getElementById('score'),
      multiplier: document.getElementById('multiplier'),
      lives: document.getElementById('lives'),
      card: document.getElementById('card'),
      idleHint: document.getElementById('idleHint'),
      problem: document.getElementById('problem'),
      choices: [
        document.getElementById('choice0'),
        document.getElementById('choice1'),
        document.getElementById('choice2')
      ],
      explain: document.getElementById('explain'),
      explainList: document.getElementById('explainList'),
      tip: document.getElementById('tip'),
      nextBtn: document.getElementById('nextBtn'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      finalScore: document.getElementById('finalScore'),
      submitName: document.getElementById('submitName'),
      submitScore: document.getElementById('submitScore'),
      closeModal: document.getElementById('closeModal'),
      lbList: document.getElementById('lbList'),
      clearLb: document.getElementById('clearLb')
    };

    // =============================
    // UTILS
    // =============================
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const shuffle = (arr) => arr.map(v => [Math.random(), v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
    const nowDateString = () => new Date().toLocaleDateString();

    function setLivesDisplay(value) {
      const hearts = '❤️'.repeat(value) + '🖤'.repeat(CONFIG.maxLives - value);
      el.lives.textContent = hearts;
    }

    function setMultiplierDisplay(streak) {
      state.multiplier = 1 + Math.floor(streak / 3);
      el.multiplier.textContent = 'x' + state.multiplier;
    }

    function spawnXpPopup(text, anchorEl) {
      const rect = anchorEl.getBoundingClientRect();
      const xp = document.createElement('div');
      xp.className = 'xp';
      xp.textContent = text;
      xp.style.left = (rect.left + rect.width/2) + 'px';
      xp.style.top = (rect.top) + 'px';
      document.body.appendChild(xp);
      setTimeout(() => xp.remove(), 700);
    }

    // =============================
    // PROBLEM GENERATOR (Math + Social Studies)
    // =============================
    // NOTE: To extend problem types, add a generator that returns { text, answer }
    // and update selectRangeByGradeDifficulty for ranges.
    function selectRangeByGradeDifficulty(grade, difficulty) {
      const d = difficulty;
      if (grade <= 2) {
        if (d === 'Easy') return { min: 0, max: 20 };
        if (d === 'Medium') return { min: 0, max: 50 };
        return { min: 0, max: 100 };
      } else if (grade <= 4) {
        if (d === 'Easy') return { min: 2, max: 12 };
        if (d === 'Medium') return { min: 10, max: 99 };
        return { min: 10, max: 99 };
      } else if (grade <= 6) {
        // For fractions/decimals/simple linear, use ranges that keep numbers small
        return { min: 1, max: 20 };
      } else {
        // 7-8: percentages/ratios/pythagorean
        return { min: 3, max: 20 };
      }
    }

    function generateProblem(grade, difficulty) {
      if (state.subject === 'SocialStudies') {
        return generateSocialStudiesProblem(grade);
      }
      const range = selectRangeByGradeDifficulty(grade, difficulty);
      // Grades 1-2: addition/subtraction
      if (grade <= 2) {
        const a = randInt(range.min, range.max);
        const b = randInt(range.min, range.max);
        const op = Math.random() < 0.5 ? '+' : '-';
        const ans = op === '+' ? a + b : a - b;
        return { text: `${a} ${op} ${b} = ?`, answer: ans, meta: { kind: op === '+' ? 'add' : 'sub', a, b } };
      }

      // Grades 3-4: multiplication/division
      if (grade <= 4) {
        if (difficulty === 'Easy') {
          const a = randInt(range.min, range.max);
          const b = randInt(range.min, range.max);
          const op = Math.random() < 0.5 ? '×' : '÷';
          if (op === '×') return { text: `${a} × ${b} = ?`, answer: a * b, meta: { kind: 'mul', a, b } };
          const prod = a * b;
          return { text: `${prod} ÷ ${a} = ?`, answer: b, meta: { kind: 'div', prod, a, b } };
        } else if (difficulty === 'Medium') {
          const a = randInt(10, 99);
          const b = randInt(2, 9);
          const op = Math.random() < 0.6 ? '×' : '÷';
          if (op === '×') return { text: `${a} × ${b} = ?`, answer: a * b, meta: { kind: 'mul', a, b } };
          const prod = a * b;
          return { text: `${prod} ÷ ${a} = ?`, answer: b, meta: { kind: 'div', prod, a, b } };
        } else {
          const a = randInt(10, 99);
          const b = randInt(10, 99);
          return { text: `${a} × ${b} = ?`, answer: a * b, meta: { kind: 'mul', a, b } };
        }
      }

      // Grades 5-6: fractions/decimals/linear eq (calculation variants only)
      if (grade <= 6) {
        const type = ['fraction', 'decimal', 'linear'][randInt(0, 2)];
        if (type === 'fraction') {
          // Simplify like a/b + c/d where d is small
          const a = randInt(1, range.max);
          const b = randInt(2, 9);
          const c = randInt(1, range.max);
          const d = randInt(2, 9);
          const num = a * d + c * b;
          const den = b * d;
          const value = +(num / den).toFixed(2);
          return { text: `${a}/${b} + ${c}/${d} ≈ ? (2dp)`, answer: value, meta: { kind: 'fracAdd', a, b, c, d, num, den } };
        }
        if (type === 'decimal') {
          const a = +(randInt(range.min, range.max) + Math.random()).toFixed(1);
          const b = +(randInt(range.min, range.max) + Math.random()).toFixed(1);
          const op = Math.random() < 0.5 ? '+' : '-';
          const ans = +(op === '+' ? a + b : a - b).toFixed(1);
          return { text: `${a} ${op} ${b} = ?`, answer: ans, meta: { kind: op === '+' ? 'decAdd' : 'decSub', a, b } };
        }
        // linear: x + k = n  OR  kx = n
        if (Math.random() < 0.5) {
          const k = randInt(1, 12);
          const n = randInt(k + 1, 40);
          return { text: `Solve x + ${k} = ${n}`, answer: n - k, meta: { kind: 'linAdd', k, n } };
        } else {
          const k = randInt(2, 12);
          const x = randInt(2, 12);
          return { text: `Solve ${k}x = ${k * x}`, answer: x, meta: { kind: 'linMul', k, prod: k * x } };
        }
      }

      // Grades 7-8: percentages, ratios, Pythagorean (numerical only)
      const type = ['percent', 'ratio', 'pythag'][randInt(0, 2)];
      if (type === 'percent') {
        const base = randInt(20, 200);
        const p = [10, 12.5, 20, 25, 30, 40, 50][randInt(0, 6)];
        const ans = +((p / 100) * base).toFixed(2);
        return { text: `${p}% of ${base} = ?`, answer: ans, meta: { kind: 'percent', p, base } };
      }
      if (type === 'ratio') {
        // Simplify a:b where gcd(a,b) > 1, ask for simplified a:b
        const a = randInt(4, 30);
        const b = randInt(4, 30);
        const g = gcd(a, b);
        return { text: `Simplify ratio ${a}:${b}`, answer: `${a/g}:${b/g}`, meta: { kind: 'ratio', a, b, g } };
      }
      // Pythagorean: find c for legs a,b
      const a = randInt(3, 15);
      const b = randInt(3, 15);
      const c = Math.sqrt(a*a + b*b);
      const rounded = Number.isInteger(c) ? c : +c.toFixed(2);
      return { text: `Right triangle legs ${a}, ${b}. c = ?`, answer: rounded, meta: { kind: 'pythag', a, b, c: rounded } };
    }

    function gcd(a, b){ return b ? gcd(b, a % b) : a; }

    // Social Studies generator
    // Simple age-appropriate MCQs aligned broadly with Odisha state board themes
    // NOTE: These are illustrative placeholders; refine with exact text from textbooks if needed.
    const SS_BANK = {
      1: [
        { q: 'Which one is a place where you live?', a: 'Home', d: ['Market','School'], tip: 'Home is where your family lives.', correctWhy: 'Home is the place where we live with our family every day.', reasons: { 'Market': 'A market is a place to buy and sell things, not to live.', 'School': 'A school is for learning; students go back home after classes.' } },
        { q: 'Who helps us cross the road safely?', a: 'Traffic police', d: ['Doctor','Postman'], tip: 'Traffic police manage roads and signals.', correctWhy: 'Traffic police control traffic and help pedestrians cross safely.', reasons: { 'Doctor': 'Doctors treat sick people, not manage roads.', 'Postman': 'Postmen deliver letters and parcels, not control traffic.' } },
        { q: 'What do we call the group of people in a house?', a: 'Family', d: ['Team','Crowd'], tip: 'Family members care for each other.', correctWhy: 'People living together related by love and care are a family.', reasons: { 'Team': 'A team works together for a task or game, not a household.', 'Crowd': 'A crowd is a large group in a public place, not a household.' } }
      ],
      2: [
        { q: 'What is the festival of lights?', a: 'Diwali', d: ['Holi','Eid'], tip: 'People light diyas and decorate homes.', correctWhy: 'Diwali is called the festival of lights because homes are lit with diyas.', reasons: { 'Holi': 'Holi is the festival of colors, not lights.', 'Eid': 'Eid celebrates prayer and feasting after Ramadan; not mainly lights.' } },
        { q: 'What is our national flag called?', a: 'Tiranga', d: ['Ashoka','Padma'], tip: 'It has three colors and the Ashoka Chakra.', correctWhy: 'The national flag is called Tiranga (three colors).', reasons: { 'Ashoka': 'Ashoka is a Mauryan emperor; his Chakra is on the flag.', 'Padma': 'Padma means lotus; it is not the name of the flag.' } },
        { q: 'Who delivers letters?', a: 'Postman', d: ['Farmer','Teacher'], tip: 'Postal workers bring mail to homes.', correctWhy: 'Postmen work in the postal service to deliver letters and parcels.', reasons: { 'Farmer': 'Farmers grow crops; they do not deliver mail.', 'Teacher': 'Teachers educate students; they do not deliver mail.' } }
      ],
      3: [
        { q: 'What is the capital of Odisha?', a: 'Bhubaneswar', d: ['Cuttack','Puri'], tip: 'Known as the City of Temples.', correctWhy: 'Bhubaneswar is the present capital city of Odisha.', reasons: { 'Cuttack': 'Cuttack was a former capital and is a major city but not current capital.', 'Puri': 'Puri is a famous pilgrimage town, not the capital.' } },
        { q: 'Which sea is along Odisha’s coast?', a: 'Bay of Bengal', d: ['Arabian Sea','Indian Ocean'], tip: 'Odisha lies on the eastern coast of India.', correctWhy: 'Odisha’s coastline is on the Bay of Bengal in the east.', reasons: { 'Arabian Sea': 'The Arabian Sea is on India’s western side.', 'Indian Ocean': 'The Indian Ocean is larger; Odisha directly borders the Bay of Bengal.' } },
        { q: 'Who is the head of a school?', a: 'Principal', d: ['Mayor','Collector'], tip: 'Leads the school and teachers.', correctWhy: 'The Principal is the administrative head of a school.', reasons: { 'Mayor': 'A Mayor heads a city’s municipal body, not a school.', 'Collector': 'A District Collector is a district administrator, not a school head.' } }
      ],
      4: [
        { q: 'What do we call the rules of a country?', a: 'Constitution', d: ['Newspaper','Calendar'], tip: 'It guides how the country is run.', correctWhy: 'The Constitution is the supreme law that sets rules for the country.', reasons: { 'Newspaper': 'A newspaper carries daily news, not the nation’s rules.', 'Calendar': 'A calendar shows dates; it is not a rulebook.' } },
        { q: 'What is a village leader often called?', a: 'Sarpanch', d: ['Governor','Minister'], tip: 'Leads the Gram Panchayat.', correctWhy: 'A Sarpanch is the elected head of a Gram Panchayat.', reasons: { 'Governor': 'A Governor is the head of a state, not a village.', 'Minister': 'A Minister serves in government; not the village council head.' } },
        { q: 'Which festival is famous in Puri?', a: 'Rath Yatra', d: ['Bihu','Pongal'], tip: 'Chariots carry Lord Jagannath.', correctWhy: 'Rath Yatra in Puri features Lord Jagannath’s chariot procession.', reasons: { 'Bihu': 'Bihu is celebrated mainly in Assam.', 'Pongal': 'Pongal is a harvest festival in Tamil Nadu.' } }
      ],
      5: [
        { q: 'Who wrote the national anthem of India?', a: 'Rabindranath Tagore', d: ['Bankim Chandra','Sarojini Naidu'], tip: 'Composed “Jana Gana Mana”.', correctWhy: 'Rabindranath Tagore composed “Jana Gana Mana,” our national anthem.', reasons: { 'Bankim Chandra': 'Bankim Chandra wrote “Vande Mataram,” not the anthem.', 'Sarojini Naidu': 'Sarojini Naidu was a poet and leader but did not write the anthem.' } },
        { q: 'Which line divides Earth into two halves?', a: 'Equator', d: ['Tropic of Cancer','Prime Meridian'], tip: 'It is at 0° latitude.', correctWhy: 'The Equator at 0° latitude divides Earth into North and South.', reasons: { 'Tropic of Cancer': 'It is a latitude at ~23.5°N; not the divider of halves.', 'Prime Meridian': 'It is 0° longitude; divides East and West, not North/South.' } },
        { q: 'What is Odisha’s famous classical dance?', a: 'Odissi', d: ['Kathakali','Bharatanatyam'], tip: 'Graceful poses and temple origins.', correctWhy: 'Odissi is the classical dance form that originated in Odisha.', reasons: { 'Kathakali': 'Kathakali is a classical dance from Kerala.', 'Bharatanatyam': 'Bharatanatyam is a classical dance from Tamil Nadu.' } }
      ],
      6: [
        { q: 'Who built the Konark Sun Temple?', a: 'Narasimha Deva I', d: ['Ashoka','Akbar'], tip: 'Eastern Ganga dynasty king.', correctWhy: 'King Narasimha Deva I of the Eastern Ganga dynasty built it in the 13th century.', reasons: { 'Ashoka': 'Ashoka was a Mauryan emperor (3rd century BCE), much earlier.', 'Akbar': 'Akbar was a Mughal emperor (16th century), not linked to Konark’s construction.' } },
        { q: 'What is the state animal of Odisha?', a: 'Sambar', d: ['Tiger','Elephant'], tip: 'A large deer native to India.', correctWhy: 'Sambar (a large deer) is officially the state animal of Odisha.', reasons: { 'Tiger': 'Tiger is India’s national animal, not Odisha’s state animal.', 'Elephant': 'Elephant is the state animal of some states, but not Odisha.' } },
        { q: 'Panchayati Raj is governance at which level?', a: 'Local', d: ['State','Union'], tip: 'Local self-government in villages.', correctWhy: 'Panchayati Raj is local self-government at the village level.', reasons: { 'State': 'State government is at the state level, not village level.', 'Union': 'Union government is the central government, not local.' } }
      ],
      7: [
        { q: 'The Prime Meridian passes through which city?', a: 'Greenwich', d: ['Paris','Rome'], tip: '0° longitude reference line.', correctWhy: 'Greenwich in London is the reference for 0° longitude.', reasons: { 'Paris': 'Paris is near 2°E; it is not the Prime Meridian.', 'Rome': 'Rome is further east; not on 0° longitude.' } },
        { q: 'Who was the first Governor-General of independent India?', a: 'Lord Mountbatten', d: ['C. Rajagopalachari','Dr. Rajendra Prasad'], tip: 'Last Viceroy, then Governor-General.', correctWhy: 'Lord Mountbatten served as the first Governor-General in 1947.', reasons: { 'C. Rajagopalachari': 'Rajaji became Governor-General later (1948).', 'Dr. Rajendra Prasad': 'He was the first President of India, not Governor-General.' } },
        { q: 'Odisha’s major river flowing into Chilika Lake is?', a: 'Daya', d: ['Mahanadi','Brahmani'], tip: 'Daya river feeds Chilika near Puri.', correctWhy: 'The Daya River flows into Chilika Lake south of Bhubaneswar.', reasons: { 'Mahanadi': 'Mahanadi flows into the Bay of Bengal, not directly into Chilika.', 'Brahmani': 'Brahmani joins with Baitarani near Dhamra; not into Chilika.' } }
      ],
      8: [
        { q: 'Indian Parliament is located in which city?', a: 'New Delhi', d: ['Mumbai','Kolkata'], tip: 'Capital of India.', correctWhy: 'The Parliament House is in New Delhi, India’s capital city.', reasons: { 'Mumbai': 'Mumbai is a major financial city, not the capital.', 'Kolkata': 'Kolkata is a major eastern city, not the capital.' } },
        { q: 'Which cyclone-prone bay borders Odisha?', a: 'Bay of Bengal', d: ['Persian Gulf','Gulf of Aden'], tip: 'Cyclones often form here.', correctWhy: 'Odisha borders the Bay of Bengal where many cyclones form.', reasons: { 'Persian Gulf': 'The Persian Gulf is in West Asia, far from Odisha.', 'Gulf of Aden': 'The Gulf of Aden lies near Yemen and Somalia, not India.' } },
        { q: 'Fundamental Rights are part of which document?', a: 'Constitution of India', d: ['Penal Code','Civil Code'], tip: 'They protect citizens’ freedoms.', correctWhy: 'Fundamental Rights are listed in the Constitution of India.', reasons: { 'Penal Code': 'The Penal Code defines crimes and punishments, not rights.', 'Civil Code': 'Civil codes govern civil matters; rights are in the Constitution.' } }
      ]
    };

    function generateSocialStudiesProblem(grade) {
      const list = SS_BANK[grade] || SS_BANK[1];
      const item = list[randInt(0, list.length - 1)];
      // choices: correct + distractors, with why
      const choices = shuffle([
        { value: item.a, why: item.correctWhy || 'This is the correct answer.', correct: true },
        ...item.d.map((x) => ({ value: x, why: (item.reasons && item.reasons[x]) || 'This option does not match the question.', correct: false }))
      ]).slice(0,3);
      const correctIndex = choices.findIndex(c => c.correct);
      return {
        text: item.q,
        answer: item.a,
        meta: { kind: 'ss', tip: item.tip, correctWhy: item.correctWhy },
        _choices: choices,
        _correctIndex: correctIndex
      };
    }

    function buildChoicesForProblem(problem) {
      // Returns { list: [{ value, why, correct }...3], correctIndex }
      const meta = problem.meta || { kind: 'generic' };
      const correct = problem.answer;
      const list = [];
      const addChoice = (value, why, isCorrect=false) => {
        // Avoid duplicates
        if (list.some(c => String(c.value) === String(value))) return false;
        list.push({ value, why, correct: isCorrect });
        return true;
      };

      // Add correct
      addChoice(correct, 'Correct', true);

      const pushUntil = (makeFn) => {
        let safety = 20;
        while (list.length < 3 && safety-- > 0) {
          const cand = makeFn();
          if (cand) addChoice(cand.value, cand.why, false);
        }
      };

      const k = meta.kind;
      switch (k) {
        case 'add': {
          const trueVal = meta.a + meta.b;
          pushUntil(() => ({ value: trueVal + 1, why: 'Off-by-one while carrying' }));
          pushUntil(() => ({ value: meta.a - meta.b, why: 'Used subtraction instead of addition' }));
          pushUntil(() => ({ value: meta.a + (meta.b + 10), why: 'Carried an extra ten' }));
          break;
        }
        case 'sub': {
          const trueVal = meta.a - meta.b;
          pushUntil(() => ({ value: trueVal - 1, why: 'Off-by-one after borrowing' }));
          pushUntil(() => ({ value: meta.a + meta.b, why: 'Added instead of subtracting' }));
          pushUntil(() => ({ value: meta.b - meta.a, why: 'Swapped order (b - a)' }));
          break;
        }
        case 'mul': {
          const trueVal = meta.a * meta.b;
          pushUntil(() => ({ value: meta.a * (meta.b + 1), why: 'One factor too large' }));
          pushUntil(() => ({ value: meta.a + meta.b, why: 'Added instead of multiplied' }));
          pushUntil(() => ({ value: meta.a * Math.max(1, meta.b - 1), why: 'One factor too small' }));
          break;
        }
        case 'div': {
          // prod ÷ a = b
          pushUntil(() => ({ value: meta.a, why: 'Confused divisor with quotient' }));
          pushUntil(() => ({ value: Math.max(1, meta.b - 1), why: 'Quotient off by one' }));
          pushUntil(() => ({ value: meta.b + 1, why: 'Quotient off by one' }));
          break;
        }
        case 'fracAdd': {
          const approx = +(meta.num / meta.den).toFixed(2);
          pushUntil(() => ({ value: +(((meta.a + meta.c) / (meta.b + meta.d))).toFixed(2), why: 'Added numerators and denominators' }));
          pushUntil(() => ({ value: +((meta.a/meta.b) + (meta.c/meta.d)).toFixed(1), why: 'Rounded too early' }));
          pushUntil(() => ({ value: +(((meta.a + meta.c) / meta.b).toFixed(2)), why: 'Kept first denominator only' }));
          break;
        }
        case 'decAdd': {
          const trueVal = +(meta.a + meta.b).toFixed(1);
          pushUntil(() => ({ value: Math.trunc(meta.a) + Math.trunc(meta.b), why: 'Ignored decimals' }));
          pushUntil(() => ({ value: +(meta.a - meta.b).toFixed(1), why: 'Used subtraction instead' }));
          pushUntil(() => ({ value: +((meta.a + meta.b).toFixed(0)), why: 'Rounded to whole number' }));
          break;
        }
        case 'decSub': {
          const trueVal = +(meta.a - meta.b).toFixed(1);
          pushUntil(() => ({ value: Math.trunc(meta.a) - Math.trunc(meta.b), why: 'Ignored decimals' }));
          pushUntil(() => ({ value: +(meta.a + meta.b).toFixed(1), why: 'Used addition instead' }));
          pushUntil(() => ({ value: +((meta.a - meta.b).toFixed(0)), why: 'Rounded to whole number' }));
          break;
        }
        case 'linAdd': {
          pushUntil(() => ({ value: meta.n + meta.k, why: 'Added k to both sides' }));
          pushUntil(() => ({ value: meta.k, why: 'Mistook k for the answer' }));
          pushUntil(() => ({ value: meta.n, why: 'Forgot to isolate x' }));
          break;
        }
        case 'linMul': {
          const trueX = meta.prod / meta.k;
          pushUntil(() => ({ value: meta.prod - meta.k, why: 'Subtracted coefficient' }));
          pushUntil(() => ({ value: meta.prod * meta.k, why: 'Multiplied instead of dividing' }));
          pushUntil(() => ({ value: Math.max(1, trueX + 1), why: 'Off by one' }));
          break;
        }
        case 'percent': {
          pushUntil(() => ({ value: +(meta.base / (meta.p/100)).toFixed(2), why: 'Divided by the percent' }));
          pushUntil(() => ({ value: +(meta.base * meta.p).toFixed(2), why: 'Forgot to convert percent to decimal' }));
          pushUntil(() => ({ value: +(meta.base * (100/meta.p)).toFixed(2), why: 'Inverted percent' }));
          break;
        }
        case 'ratio': {
          const wrongFactor = Math.max(2, meta.g - 1);
          pushUntil(() => ({ value: `${Math.round(meta.a/wrongFactor)}:${Math.round(meta.b/wrongFactor)}`, why: `Divided by wrong factor (/${wrongFactor})` }));
          pushUntil(() => ({ value: `${meta.a}:${meta.b}`, why: 'Left ratio unsimplified' }));
          pushUntil(() => ({ value: `${meta.b/meta.g}:${meta.a/meta.g}`, why: 'Swapped parts after simplifying' }));
          break;
        }
        case 'pythag': {
          pushUntil(() => ({ value: meta.a + meta.b, why: 'Added legs without squaring' }));
          pushUntil(() => ({ value: +(Math.sqrt(meta.a + meta.b)).toFixed(2), why: 'Square root of sum of legs' }));
          pushUntil(() => ({ value: meta.a*meta.a + meta.b*meta.b, why: 'Forgot final square root' }));
          break;
        }
        default: {
          // Generic fallbacks near the correct number
          const base = Number(correct) || 0;
          pushUntil(() => ({ value: base + 1, why: 'Off-by-one' }));
          pushUntil(() => ({ value: base - 1, why: 'Off-by-one' }));
          pushUntil(() => ({ value: base + 2, why: 'Small arithmetic slip' }));
        }
      }

      // If still less than 3 (e.g., string/ratio duplicates), pad with +/- small tweaks
      const makePad = () => {
        const cv = correct;
        if (typeof cv === 'number') {
          const delta = randInt(2, 4) * (Math.random()<0.5?-1:1);
          return { value: +(cv + delta).toFixed(2), why: 'Plausible miscalculation' };
        } else {
          const [p,q] = String(cv).split(':').map(Number);
          return { value: `${Math.max(1,p+1)}:${Math.max(1,q-1)}`, why: 'Adjusted one part of ratio' };
        }
      };
      while (list.length < 3) addChoice(...Object.values(makePad()), false);

      const shuffled = shuffle(list);
      const correctIndex = shuffled.findIndex(c => c.correct);
      return { list: shuffled, correctIndex };
    }

    // =============================
    // GAME LOGIC
    // =============================
    function resetState() {
      state.score = 0;
      state.streak = 0;
      state.multiplier = 1;
      state.lives = CONFIG.maxLives;
      state.timeLeft = CONFIG.startTimeSeconds;
      state.timerId = null;
      state.currentProblem = null;
      state.currentChoices = [];
      state.currentExplainData = [];
      state.correctIndex = 0;
      state.gameActive = false;
      renderHud();
      el.card.style.display = 'none';
      el.idleHint.style.display = 'block';
    }

    function renderHud() {
      el.time.textContent = state.timeLeft;
      el.score.textContent = state.score;
      setMultiplierDisplay(state.streak);
      setLivesDisplay(state.lives);
    }

    function startTimer() {
      clearInterval(state.timerId);
      state.timerId = setInterval(() => {
        if (!state.gameActive) return;
        state.timeLeft--;
        el.time.textContent = state.timeLeft;
        if (state.timeLeft <= 0) {
          endGame('Time up!');
        }
      }, 1000);
    }

    function nextProblem() {
      const p = generateProblem(state.grade, state.difficulty);
      state.currentProblem = p;
      if (state.subject === 'SocialStudies' && p._choices) {
        state.currentChoices = p._choices.map(c => c.value);
        state.currentExplainData = p._choices;
        state.correctIndex = p._correctIndex;
      } else {
        const built = buildChoicesForProblem(p);
        state.currentChoices = built.list.map(c => c.value);
        state.currentExplainData = built.list;
        state.correctIndex = built.correctIndex;
      }
      renderProblem();
    }

    function renderProblem() {
      el.problem.textContent = state.currentProblem.text;
      state.currentChoices.forEach((c, i) => {
        const label = i === 0 ? 'A' : (i === 1 ? 'B' : 'C');
        el.choices[i].textContent = `${label}) ${c}`;
        el.choices[i].classList.remove('correct','wrong');
      });
      el.explain.style.display = 'none';
      el.idleHint.style.display = 'none';
      el.card.style.display = 'block';
    }

    function handleAnswer(index) {
      if (!state.gameActive) return;
      const correct = index === state.correctIndex;
      const btn = el.choices[index];
      if (state.mode === 'Learning') {
        // Always show explanation, do not change timer/lives/score
        if (correct) btn.classList.add('correct'); else btn.classList.add('wrong');
        showExplanation();
        return;
      }
      if (correct) {
        btn.classList.add('correct');
        state.streak += 1;
        setMultiplierDisplay(state.streak);
        const gained = CONFIG.basePoints * state.multiplier;
        state.score += gained;
        el.score.textContent = state.score;
        spawnXpPopup(`+${gained}`, btn);
        setTimeout(nextProblem, 220);
      } else {
        btn.classList.add('wrong');
        state.lives -= 1;
        state.streak = 0;
        setMultiplierDisplay(state.streak);
        setLivesDisplay(state.lives);
        if (state.lives <= 0) {
          return endGame('No lives left');
        }
      }
    }

    function startGame() {
      state.playerName = el.playerName.value.trim();
      state.subject = el.subject.value;
      state.mode = el.mode.value;
      state.grade = parseInt(el.grade.value, 10);
      state.difficulty = el.difficulty.value;
      resetState();
      state.gameActive = true;
      renderHud();
      nextProblem();
      if (state.mode === 'Competitive') {
        startTimer();
      } else {
        // Learning mode visuals
        el.time.textContent = '∞';
      }
      el.submitName.value = state.playerName;
    }

    function endGame(reason) {
      state.gameActive = false;
      clearInterval(state.timerId);
      el.finalScore.textContent = state.score;
      openModal();
    }

    // =============================
    // UI HANDLERS
    // =============================
    function openModal() {
      el.modalBackdrop.style.display = 'flex';
    }
    function closeModal() {
      el.modalBackdrop.style.display = 'none';
    }

    function showExplanation() {
      const meta = state.currentProblem.meta || { kind: 'generic' };
      const tip = tipFor(meta);
      el.explainList.innerHTML = '';
      state.currentExplainData.forEach((item, i) => {
        const label = i === 0 ? 'A' : (i === 1 ? 'B' : 'C');
        const ok = item.correct === true;
        const why = ok ? correctExplanation(meta) : item.why;
        const row = document.createElement('div');
        row.innerHTML = `<strong style="color:${ok ? 'var(--accent-2)' : 'var(--danger)'}">${label}) ${item.value}</strong> — ${why}`;
        el.explainList.appendChild(row);
      });
      el.tip.innerHTML = `<strong>Tip:</strong> ${tip}`;
      el.explain.style.display = 'block';
    }

    function correctExplanation(meta) {
      switch (meta.kind) {
        case 'add': return `${meta.a} + ${meta.b} = ${meta.a + meta.b}`;
        case 'sub': return `${meta.a} - ${meta.b} = ${meta.a - meta.b}`;
        case 'mul': return `${meta.a} × ${meta.b} = ${meta.a * meta.b}`;
        case 'div': return `${meta.prod} ÷ ${meta.a} = ${meta.b}`;
        case 'fracAdd': return `Common denom ${meta.b}×${meta.d} = ${meta.b*meta.d}. Sum ${meta.a}×${meta.d} + ${meta.c}×${meta.b} = ${meta.num}/${meta.den} ≈ ${(meta.num/meta.den).toFixed(2)}`;
        case 'decAdd': return `Align decimals: ${meta.a} + ${meta.b} = ${(meta.a + meta.b).toFixed(1)}`;
        case 'decSub': return `Align decimals: ${meta.a} - ${meta.b} = ${(meta.a - meta.b).toFixed(1)}`;
        case 'linAdd': return `x + ${meta.k} = ${meta.n} ⇒ x = ${meta.n} - ${meta.k} = ${meta.n - meta.k}`;
        case 'linMul': return `${meta.k}x = ${meta.prod} ⇒ x = ${meta.prod}/${meta.k} = ${meta.prod/meta.k}`;
        case 'percent': return `${meta.p}% of ${meta.base} = ${meta.base} × ${meta.p}/100 = ${((meta.p/100)*meta.base).toFixed(2)}`;
        case 'ratio': return `gcd(${meta.a}, ${meta.b}) = ${meta.g}. Simplify: ${meta.a}/${meta.g}:${meta.b}/${meta.g}`;
        case 'pythag': return `c = √(${meta.a}² + ${meta.b}²) = √(${meta.a*meta.a} + ${meta.b*meta.b}) ≈ ${meta.c}`;
        default: return `This is the correct result.`;
      }
    }

    // =============================
    // EXPLANATION BUILDER
    // =============================
    function buildExplanations(problem, choices, correctIdx) {
      const meta = problem.meta || { kind: 'generic' };
      const correct = choices[correctIdx];
      const perChoice = choices.map((c, i) => explainChoice(meta, c, i === correctIdx, correct));
      const tip = tipFor(meta);
      return { perChoice, tip };
    }

    function explainChoice(meta, value, isCorrect, correctValue) {
      if (isCorrect) return explanationFor(meta, true, value);
      return explanationFor(meta, false, value, correctValue);
    }

    function explanationFor(meta, isCorrect, value, correctValue) {
      const k = meta.kind;
      if (isCorrect) {
        switch (k) {
          case 'add': return `${meta.a} + ${meta.b} = ${meta.a + meta.b}`;
          case 'sub': return `${meta.a} - ${meta.b} = ${meta.a - meta.b}`;
          case 'mul': return `${meta.a} × ${meta.b} = ${meta.a * meta.b}`;
          case 'div': return `${meta.prod} ÷ ${meta.a} = ${meta.b}`;
          case 'fracAdd': return `Common denom ${meta.b}×${meta.d} = ${meta.b*meta.d}. Sum ${meta.a}×${meta.d} + ${meta.c}×${meta.b} = ${meta.num}/${meta.den} ≈ ${(meta.num/meta.den).toFixed(2)}`;
          case 'decAdd': return `Align decimals: ${meta.a} + ${meta.b} = ${(meta.a + meta.b).toFixed(1)}`;
          case 'decSub': return `Align decimals: ${meta.a} - ${meta.b} = ${(meta.a - meta.b).toFixed(1)}`;
          case 'linAdd': return `x + ${meta.k} = ${meta.n} ⇒ x = ${meta.n} - ${meta.k} = ${meta.n - meta.k}`;
          case 'linMul': return `${meta.k}x = ${meta.prod} ⇒ x = ${meta.prod}/${meta.k} = ${meta.prod/meta.k}`;
          case 'percent': return `${meta.p}% of ${meta.base} = ${meta.base} × ${meta.p}/100 = ${((meta.p/100)*meta.base).toFixed(2)}`;
          case 'ratio': return `gcd(${meta.a}, ${meta.b}) = ${meta.g}. Simplify: ${meta.a}/${meta.g}:${meta.b}/${meta.g}`;
          case 'pythag': return `c = √(${meta.a}² + ${meta.b}²) = √(${meta.a*meta.a} + ${meta.b*meta.b}) ≈ ${meta.c}`;
          default: return `This is the correct result.`;
        }
      } else {
        // Wrong: generic reasons per topic
        switch (k) {
          case 'add': return `This equals ${value}. Likely a carry/borrowing slip. Correct is ${meta.a + meta.b}.`;
          case 'sub': return `This equals ${value}. Check subtraction order: ${meta.a} - ${meta.b} = ${meta.a - meta.b}.`;
          case 'mul': return `This equals ${value}. Recheck the table: ${meta.a} × ${meta.b} = ${meta.a * meta.b}.`;
          case 'div': return `This equals ${value}. Use inverse: ${meta.prod} ÷ ${meta.a} = ${meta.b}.`;
          case 'fracAdd': return `This equals ${value}. Don't add tops and bottoms directly. Use common denominator → ${(meta.num/meta.den).toFixed(2)}.`;
          case 'decAdd': return `This equals ${value}. Align decimal points; ${meta.a} + ${meta.b} = ${(meta.a + meta.b).toFixed(1)}.`;
          case 'decSub': return `This equals ${value}. Align decimal points; ${meta.a} - ${meta.b} = ${(meta.a - meta.b).toFixed(1)}.`;
          case 'linAdd': return `This equals ${value}. Remember to subtract ${meta.k} from both sides: ${meta.n} - ${meta.k}.`;
          case 'linMul': return `This equals ${value}. Divide both sides by ${meta.k}: ${meta.prod}/${meta.k}.`;
          case 'percent': return `This equals ${value}. Compute base × percent/100, not divide/multiply wrongly.`;
          case 'ratio': return `This equals ${value}. Make sure to divide both parts by gcd ${meta.g}.`;
          case 'pythag': return `This equals ${value}. Use a² + b² then square root, not a + b.`;
          default: return `Not the result of the required operation. Correct is ${correctValue}.`;
        }
      }
    }

    function tipFor(meta) {
      switch (meta.kind) {
        case 'add': return 'Stack numbers vertically and add ones → tens. Say it aloud.';
        case 'sub': return 'Subtract top-bottom. If needed, borrow from the next column.';
        case 'mul': return 'Break into parts: (a×b) = (a×10) + (a×units), or use tables.';
        case 'div': return 'Think “how many groups of a in prod?” Check by multiplying back.';
        case 'fracAdd': return 'Find common denominator first. Multiply top and bottom by the same number.';
        case 'decAdd': return 'Line up the decimal points before adding. Keep one decimal place.';
        case 'decSub': return 'Line up decimals; add a trailing zero if helpful.';
        case 'linAdd': return 'Do the same to both sides to isolate x.';
        case 'linMul': return 'Divide both sides by the coefficient of x.';
        case 'percent': return 'Convert percent to decimal (p/100) then multiply by the base.';
        case 'ratio': return 'Divide both parts by the greatest common divisor.';
        case 'pythag': return 'Square, add, then square root: c = √(a²+b²).';
        case 'ss': return meta.tip || 'Re-read the question; pick the most specific correct option.';
        default: return 'Read the operation carefully; estimate to check your result.';
      }
    }

    function wireEvents() {
      el.playerName.addEventListener('input', () => {
        el.startBtn.disabled = el.playerName.value.trim().length === 0;
      });
      el.startBtn.addEventListener('click', () => startGame());
      el.resetBtn.addEventListener('click', () => resetState());
      el.closeModal.addEventListener('click', () => closeModal());
      el.submitScore.addEventListener('click', () => {
        saveScore();
        renderLeaderboard();
        closeModal();
      });
      el.clearLb.addEventListener('click', () => {
        if (confirm('Clear all leaderboard entries on this device?')) {
          localStorage.removeItem(CONFIG.leaderboardKey);
          renderLeaderboard();
        }
      });
      el.choices.forEach((cEl, idx) => {
        cEl.addEventListener('click', () => handleAnswer(idx));
      });
      el.nextBtn.addEventListener('click', () => nextProblem());
    }

    // =============================
    // LEADERBOARD
    // =============================
    function loadLeaderboard() {
      try {
        const raw = localStorage.getItem(CONFIG.leaderboardKey);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        return [];
      }
    }

    function saveScore() {
      const name = el.submitName.value.trim() || 'Player';
      const entry = {
        name,
        score: state.score,
        grade: state.grade,
        difficulty: state.difficulty,
        subject: state.subject || 'Math',
        date: nowDateString()
      };
      const list = loadLeaderboard();
      list.push(entry);
      list.sort((a,b) => b.score - a.score);
      const top5 = list.slice(0, 5);
      localStorage.setItem(CONFIG.leaderboardKey, JSON.stringify(top5));
    }

    function renderLeaderboard() {
      const list = loadLeaderboard();
      el.lbList.innerHTML = '';
      if (list.length === 0) {
        el.lbList.innerHTML = '<div class="lb-meta">No scores yet. Be the first!</div>';
        return;
      }
      list.forEach((e, i) => {
        const row = document.createElement('div');
        row.className = 'lb-item';
        row.innerHTML = `
          <div>
            <strong>#${i+1} ${e.name}</strong>
            <div class="lb-meta">${e.subject || 'Math'} • Grade ${e.grade} • ${e.difficulty} • ${e.date}</div>
          </div>
          <div style="font-weight:800; color: var(--gold);">${e.score}</div>
        `;
        el.lbList.appendChild(row);
      });
    }

    // Init
    wireEvents();
    renderLeaderboard();
    resetState();
  </script>
</body>
</html>


